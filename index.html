<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubSkate</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #87CEEB; /* Gökyüzü rengi */
            font-family: Arial, sans-serif;
            color: white;
        } 
        canvas { 
            display: block; 
        }
        /* UI Elemanları Stilleri */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
        }
        #shop-button, #score-display {
            pointer-events: auto;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #shop-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        #shop-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            text-align: center;
            display: none;
            pointer-events: auto;
            max-width: 90%;
            width: 500px;
            max-height: 90%;
            overflow-y: auto;
            z-index: 20;
        }
        #shop-display h2 {
            margin-top: 0;
            color: #FFD700;
        }
        .shop-item {
            background-color: rgba(50, 50, 50, 0.7);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        .shop-item button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .shop-item button:hover {
            background-color: #45a049;
        }
        #shop-message {
            color: yellow;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="score-display" style="align-self: flex-end; margin-bottom: auto;">
            Skor: 0<br>Coin: 0
        </div>
        <button id="shop-button" style="align-self: flex-start; margin-top: auto;">Dükkan</button>
    </div>

    <div id="shop-display">
        <h2>SubSkate Dükkanı</h2>
        <div id="shop-items-container">
            </div>
        <p id="shop-message"></p>
        <button id="close-shop-button">Kapat</button>
    </div>
    
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';

        // --- UI Elemanlarına Erişim ---
        const scoreDisplay = document.getElementById('score-display');
        const shopButton = document.getElementById('shop-button');
        const shopDisplay = document.getElementById('shop-display');
        const closeShopButton = document.getElementById('close-shop-button');
        const shopItemsContainer = document.getElementById('shop-items-container');
        const shopMessage = document.getElementById('shop-message');

        // --- Dükkan Verileri (Geçici) ---
        const shopItems = [
            { id: 'char1', type: 'character', name: 'Hızlı Ayşe', price: 0, owned: true, current: true, description: 'Başlangıç karakteri.' },
            { id: 'char2', type: 'character', name: 'Zıplayan Can', price: 250, owned: false, current: false, description: 'Daha yüksek zıplama.' },
            { id: 'power1', type: 'power', name: 'Mıknatıs (5x)', price: 50, description: '5 saniye boyunca coinleri çeker.' },
            { id: 'power2', type: 'power', name: 'Kalkan (1x)', price: 75, description: 'Bir engelden korur.' },
            { id: 'potion1', type: 'potion', name: 'Can İksiri', price: 200, description: 'Canını fuler.' }
        ];

        let playerCoins = 0; // Oyuncunun coinleri
        let playerCurrentCharacterId = 'char1'; // Aktif karakter

        // --- Dükkanı Doldurma Fonksiyonu ---
        function populateShop() {
            shopItemsContainer.innerHTML = ''; 
            shopItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                let buttonText = 'Satın Al';
                let buttonDisabled = false;
                let itemStatus = '';

                if (item.type === 'character') {
                    if (item.current) {
                        itemStatus = ' (Aktif)';
                        buttonText = 'Aktif';
                        buttonDisabled = true;
                    } else if (item.owned) {
                        itemStatus = ' (Seç)';
                        buttonText = 'Seç';
                    }
                }

                itemDiv.innerHTML = `
                    <span>${item.name} ${itemStatus} - ${item.price} Coin</span>
                    <button id="buy-${item.id}" ${buttonDisabled ? 'disabled' : ''}>${buttonText}</button>
                `;
                shopItemsContainer.appendChild(itemDiv);

                const buyButton = itemDiv.querySelector(`#buy-${item.id}`);
                buyButton.addEventListener('click', () => handleShopPurchase(item));
            });
            scoreDisplay.innerHTML = `Skor: ${Math.floor(score)}<br>Coin: ${playerCoins}`;
        }

        // --- Satın Alma İşlevi ---
        function handleShopPurchase(item) {
            shopMessage.textContent = ''; 
            if (item.current) { // Zaten aktifse veya seçiliyse
                shopMessage.textContent = 'Bu zaten aktif karakterin!';
                return;
            }
            if (item.owned && item.type === 'character') { // Zaten sahipse ve seçmek istiyorsa
                shopItems.find(i => i.id === playerCurrentCharacterId).current = false;
                item.current = true;
                playerCurrentCharacterId = item.id;
                shopMessage.textContent = `${item.name} aktif edildi!`;
                // TODO: Karakter modelini değiştirme/güncelleme mantığı buraya gelecek
                populateShop();
                return;
            }
            if (playerCoins >= item.price) {
                playerCoins -= item.price;
                if (item.type === 'character') {
                    shopItems.find(i => i.id === playerCurrentCharacterId).current = false; 
                    item.owned = true;
                    item.current = true;
                    playerCurrentCharacterId = item.id;
                    shopMessage.textContent = `${item.name} satın alındı ve aktif edildi!`;
                    // TODO: Karakter modelini değiştirme mantığı buraya gelecek
                } else {
                    // Diğer öğeler için satın alma mantığı (power-up, iksir)
                    shopMessage.textContent = `${item.name} satın alındı!`;
                }
                populateShop(); 
            } else {
                shopMessage.textContent = 'Yeterli coinin yok!';
            }
        }

        // --- Shop Butonu Olay Dinleyicisi ---
        shopButton.addEventListener('click', () => {
            populateShop(); 
            shopDisplay.style.display = 'block'; 
            isGamePaused = true; 
        });

        closeShopButton.addEventListener('click', () => {
            shopDisplay.style.display = 'none'; 
            isGamePaused = false; 
        });

        // --- Sahne Ayarları ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Işıklandırma ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); 
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5); 
        directionalLight.position.set(0, 10, 5);
        scene.add(directionalLight);

        // --- Zemin Oluşturma (Yol) ---
        const groundGeometry = new THREE.PlaneGeometry(10, 2000); 
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x556B2F });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        scene.add(ground);

        // --- Oyuncu (İnsan Figürü ve Kıyafetler) ---
        const player = new THREE.Group(); // Ana oyuncu grubu

        // Gövde (Üst)
        const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x1E90FF }); // Mavi tişört
        const playerBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.6), bodyMaterial);
        player.add(playerBody);

        // Kafa
        const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFADFAD }); // Ten rengi
        const playerHead = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), headMaterial);
        playerHead.position.y = 0.9;
        playerBody.add(playerHead); // Kafayı gövdeye ekle

        // Pantolon
        const pantsMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 }); // Yeşil pantolon
        const playerPants = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.6), pantsMaterial);
        playerPants.position.y = -0.6; // Gövdenin altına
        playerBody.add(playerPants);

        // Sol Ayak
        const shoeMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 }); // Kahverengi ayakkabı
        const playerLeftFoot = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.5), shoeMaterial);
        playerLeftFoot.position.set(-0.25, -1.2, 0.1); // Gövdenin altına ve hafif ileri
        player.add(playerLeftFoot);

        // Sağ Ayak
        const playerRightFoot = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.5), shoeMaterial);
        playerRightFoot.position.set(0.25, -1.2, 0.1); // Gövdenin altına ve hafif ileri
        player.add(playerRightFoot);

        // Kollar (Hareket için daha sonra eklenecek)
        const armMaterial = new THREE.MeshLambertMaterial({ color: 0xFADFAD }); // Ten rengi
        const playerLeftArm = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), armMaterial);
        playerLeftArm.position.set(-0.5, 0.2, 0); // Omuzdan aşağıya doğru
        player.add(playerLeftArm);

        const playerRightArm = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), armMaterial);
        playerRightArm.position.set(0.5, 0.2, 0); // Omuzdan aşağıya doğru
        player.add(playerRightArm);


        player.position.set(0, 0.9, 0); // Zeminin biraz üstüne koy
        scene.add(player);


        // --- Oyun Değişkenleri ---
        const playerSpeed = 0.1; 
        const laneWidth = 3; 
        let currentLane = 0; 
        let isJumping = false;
        let jumpVelocity = 0;
        const jumpForce = 0.2;
        const gravity = -0.01;

        let score = 0;
        let lastScoreUpdateTime = performance.now(); // Skor güncelleme zamanı
        let isGamePaused = false; // Oyunu duraklatma durumu

        // --- Karakter Animasyonları İçin Değişkenler ---
        let animationTime = 0;
        const runAnimationSpeed = 0.2; // Koşu animasyonu hızı
        const jumpAnimationHeightFactor = 0.8; // Zıplama animasyonu bacak kaldırma yüksekliği
        const jumpAnimationArmSwing = 0.5; // Zıplama animasyonu kol sallama açısı
        const laneChangeAnimationSpeed = 0.15; // Şerit değiştirme dönüş hızı
        let playerRotationTarget = 0; // Hedef rotasyon açısı

        // --- Engeller ve Coinler ---
        const obstacles = [];
        const coinsArray = [];
        let spawnDistance = 50; // Başlangıçta engellerin ne kadar uzakta oluşacağı
        const minSpawnDistance = 25; // Minimum oluşma mesafesi (zorluk arttıkça)
        let lastSpawnZ = 0; // Son oluşan objenin Z pozisyonu
        
        const obstacleTypes = ['wall', 'box']; // Engel türleri
        const coinGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16); 
        const coinMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD700 }); 

        function createObstacle(lane, zPosition) {
            const obstacleGeometry = new THREE.BoxGeometry(2, 2, 0.8); 
            const obstacleMaterial = new THREE.MeshLambertMaterial({ color: 0x8B0000 }); 
            const obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial);
            
            obstacle.position.set(lane * laneWidth, 1, zPosition);
            scene.add(obstacle);
            obstacles.push(obstacle);
        }

        function createCoin(lane, zPosition) {
            const coin = new THREE.Mesh(coinGeometry, coinMaterial);
            coin.rotation.x = Math.PI / 2; 
            coin.position.set(lane * laneWidth, 0.5, zPosition);
            scene.add(coin);
            coinsArray.push(coin);
        }

        // --- Çarpışma Tespiti ---
        function checkCollision(obj1, obj2) {
            const box1 = new THREE.Box3().setFromObject(obj1);
            const box2 = new THREE.Box3().setFromObject(obj2);
            return box1.intersectsBox(box2);
        }

        // --- Klavye Kontrolleri ---
        const keys = {};
        document.addEventListener('keydown', (event) => {
            if (isGamePaused) return; 
            keys[event.key.toLowerCase()] = true;
        });
        document.addEventListener('keyup', (event) => {
            keys[event.key.toLowerCase()] = false;
        });

        // --- Dokunmatik Kontroller (Telefon İçin) ---
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (event) => {
            if (isGamePaused) return; 
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }, false);

        document.addEventListener('touchend', (event) => {
            if (isGamePaused) return; 
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;

            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;

            // Dikey kaydırma (zıplama)
            if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 50) { 
                if (dy < 0 && !isJumping) { 
                    isJumping = true;
                    jumpVelocity = jumpForce;
                    // Zıplama başlangıcı animasyonu
                    playerLeftFoot.position.y = -0.8; 
                    playerRightFoot.position.y = -0.8;
                    playerLeftArm.rotation.x = Math.PI / 4; // Kollar öne kalksın
                    playerRightArm.rotation.x = -Math.PI / 4;
                }
            } 
            // Yatay kaydırma (şerit değiştirme)
            else if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) { 
                if (dx > 0) { // Sağa kaydırma
                    currentLane = Math.min(currentLane + 1, 1);
                    playerRotationTarget = -Math.PI / 10; // Sağa doğru hafif eğil
                } else { // Sola kaydırma
                    currentLane = Math.max(currentLane - 1, -1);
                    playerRotationTarget = Math.PI / 10; // Sola doğru hafif eğil
                }
            }
        }, false);

        // --- Animasyon Döngüsü ---
        let lastFrameTime = performance.now(); 

        function animate() {
            requestAnimationFrame(animate);

            const currentTime = performance.now();
            const deltaTime = (currentTime - lastFrameTime) / 1000; 
            lastFrameTime = currentTime;

            if (isGamePaused) {
                renderer.render(scene, camera); 
                return; 
            }

            // Skor Güncelleme
            score += deltaTime; // Saniyede 1 artar
            scoreDisplay.innerHTML = `Skor: ${Math.floor(score)}<br>Coin: ${playerCoins}`;

            // Oyuncuyu sürekli ileri hareket ettir
            player.position.z -= playerSpeed;
            camera.position.z = player.position.z + 5; 

            // Oyuncunun şerit pozisyonunu güncelle ve dönüş animasyonu
            const targetX = currentLane * laneWidth;
            player.position.x += (targetX - player.position.x) * 0.1; 
            // Oyuncuyu hedefe doğru yavaşça döndür
            player.rotation.y += (playerRotationTarget - player.rotation.y) * laneChangeAnimationSpeed;


            // Zıplama Mantığı
            if (isJumping) {
                player.position.y += jumpVelocity;
                jumpVelocity += gravity; 
                
                // Zıplama animasyonu (ayaklar ve kollar)
                const jumpProgress = (player.position.y - 0.9) / (jumpForce * jumpForce / (2 * Math.abs(gravity))); // Zıplama yüksekliğine göre oran
                playerLeftFoot.position.y = -1.2 + Math.abs(Math.sin(jumpProgress * Math.PI)) * jumpAnimationHeightFactor;
                playerRightFoot.position.y = -1.2 + Math.abs(Math.sin(jumpProgress * Math.PI)) * jumpAnimationHeightFactor;
                
                playerLeftArm.rotation.x = Math.PI / 4 - Math.sin(jumpProgress * Math.PI) * jumpAnimationArmSwing;
                playerRightArm.rotation.x = -Math.PI / 4 + Math.sin(jumpProgress * Math.PI) * jumpAnimationArmSwing;


                if (player.position.y <= 0.9) { // Yere düştüğünde
                    player.position.y = 0.9;
                    isJumping = false;
                    jumpVelocity = 0;
                    // Zıplama bitti, koşu animasyonuna geri dön
                    playerLeftFoot.position.y = -1.2; 
                    playerRightFoot.position.y = -1.2;
                    playerLeftArm.rotation.x = 0; 
                    playerRightArm.rotation.x = 0;
                    playerRotationTarget = 0; // Orta şeritte düz dursun
                }
            } else {
                // Koşu Animasyonu (Yerdeyse)
                animationTime += runAnimationSpeed;
                // Ayaklar ileri-geri
                playerLeftFoot.position.z = Math.sin(animationTime) * 0.15;
                playerLeftFoot.position.y = -1.2 + Math.abs(Math.sin(animationTime)) * 0.1;

                playerRightFoot.position.z = Math.sin(animationTime + Math.PI) * 0.15; // Ters fazda
                playerRightFoot.position.y = -1.2 + Math.abs(Math.sin(animationTime + Math.PI)) * 0.1;

                // Kollar ileri-geri (ayaklara ters orantılı)
                playerLeftArm.rotation.x = Math.sin(animationTime + Math.PI) * 0.3; 
                playerRightArm.rotation.x = Math.sin(animationTime) * 0.3;
            }

            // Klavye ile zıplama
            if (keys[' '] && !isJumping) { 
                isJumping = true;
                jumpVelocity = jumpForce;
                // Zıplama başlangıcı animasyonu
                playerLeftFoot.position.y = -0.8; 
                playerRightFoot.position.y = -0.8;
                playerLeftArm.rotation.x = Math.PI / 4; 
                playerRightArm.rotation.x = -Math.PI / 4;
            }

            // Klavye ile yana kayma (A/D veya Sol/Sağ Ok)
            if (keys['a'] || keys['arrowleft']) {
                currentLane = Math.max(currentLane - 1, -1);
                playerRotationTarget = Math.PI / 10; // Sola doğru hafif eğil
                keys['a'] = false; 
                keys['arrowleft'] = false;
            }
            if (keys['d'] || keys['arrowright']) {
                currentLane = Math.min(currentLane + 1, 1);
                playerRotationTarget = -Math.PI / 10; // Sağa doğru hafif eğil
                keys['d'] = false; 
                keys['arrowright'] = false;
            }
            // Tuş basılı değilse rotasyonu sıfırla
            if (!keys['a'] && !keys['d'] && !keys['arrowleft'] && !keys['arrowright'] && !isJumping) {
                playerRotationTarget = 0;
            }


            // --- Engel ve Coin Üretimi ---
            const minZDistance = 20; // Engeller arası minimum Z mesafesi
            const maxZDistance = 40; // Engeller arası maksimum Z mesafesi
            
            // Eğer yeni engel/coin spawnlamak için yeterli mesafe geçtiyse
            if (player.position.z - lastSpawnZ < -Math.random() * (maxZDistance - minZDistance) - minZDistance) {
                 const randomLane = Math.floor(Math.random() * 3) - 1; // -1, 0, 1
                 const spawnChoice = Math.random();
                 const spawnZ = player.position.z - (Math.random() * 50 + 30); // Oyuncudan 30-80 birim ileride

                 if (spawnChoice < 0.5) { // %50 ihtimalle engel
                     createObstacle(randomLane, spawnZ);
                 } else { // %50 ihtimalle coin
                     createCoin(randomLane, spawnZ);
                 }
                 lastSpawnZ = player.position.z;
            }

            // --- Engel ve Coinleri Hareket Ettirme ve Silme ---
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                obstacle.position.z += playerSpeed; 

                // Çarpışma Tespiti
                if (checkCollision(player, obstacle)) {
                    console.log("Çarpıştın! Oyun Bitti!");
                    isGamePaused = true; 
                    shopButton.textContent = "Tekrar Oyna"; 
                    shopButton.onclick = () => { 
                        location.reload(); 
                    };
                    return; 
                }

                // Ekran dışına çıkan engelleri sil
                if (obstacle.position.z > camera.position.z + 10) {
                    scene.remove(obstacle);
                    obstacles.splice(i, 1);
                }
            }

            for (let i = coinsArray.length - 1; i >= 0; i--) {
                const coin = coinsArray[i];
                coin.position.z += playerSpeed;
                coin.rotation.y += 0.05; // Coin kendi etrafında dönsün

                // Coin toplama tespiti
                if (checkCollision(player, coin) && coin.visible) {
                    playerCoins += 1; 
                    scoreDisplay.innerHTML = `Skor: ${Math.floor(score)}<br>Coin: ${playerCoins}`;
                    scene.remove(coin); 
                    coin.visible = false; 
                }

                // Ekran dışına çıkan coinleri sil
                if (coin.position.z > camera.position.z + 10) {
                    scene.remove(coin);
                    coinsArray.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        animate();

        // --- Pencere Boyutu Değiştiğinde Yeniden Boyutlandırma ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Dükkanı başlangıçta doldur
        populateShop();
    </script>
</body>
</html>
